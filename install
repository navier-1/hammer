#!/bin/bash
#
# This script:
# - compiles the front-end CLI
# - installs it
# - installs the back-end CMake scripts
set -e

# Will need to make this up to the user and still work with everything else

HAMMER_CLI="/usr/local/bin/hammer"
HAMMER_BACKEND_DIR="/usr/local/lib/hammer"
HAMMER_CONFIG_FILE="/usr/local/etc/hammer.yml"
HAMMER_TMP_DIR="./hammer-tmp"

# Delete installation files (no harm no foul)
# TBD: should this be kept in uninstall.sh?
sudo rm -rf $HAMMER_BACKEND_DIR
sudo rm -f  $HAMMER_CLI

## Configure the (optional) CML.txt
sudo bash -c "sed 's|@@HAMMER_BACKEND_DIR@@|$HAMMER_BACKEND_DIR|g' $HAMMER_BACKEND_DIR/CMakeLists.txt > $HAMMER_BACKEND_DIR/CMakeLists.txt.tmp"
sudo rm $HAMMER_BACKEND_DIR/CMakeLists.txt
sudo mv $HAMMER_BACKEND_DIR/CMakeLists.txt.tmp $HAMMER_BACKEND_DIR/CMakeLists.txt

# Compile and install CLI
cd $HAMMER_CLI_DIR

gcc -o hammer \
    main.c \
    configuration.c \
    \
    commands/new.c \
    commands/init.c \
    commands/config.c \
    commands/commands.c \
    \
    utils/filecopy.c \
    utils/linked_list.c \
    utils/reverse_search.c \
    \
    yaml/config.c \
    yaml/transpile.c \
    yaml/dependencies.c \
    yaml/sources.c \
    yaml/toolchain.c \
    yaml/defines.c \
    yaml/settings.c \
    \
    \
    -I. \
    -Iyaml \
    -Iutils \
    -Icommands \
    \
    -DHAMMER_CONFIG_FILE="\"$HAMMER_CONFIG_FILE\"" \
    -DHAMMER_BACKEND_DIR="\"$HAMMER_BACKEND_DIR\"" \
    \
    -lyaml \
    -lcyaml \

#    -static \
#    -fsanitize=address \  # Debugging

sudo mv hammer $HAMMER_CLI
sudo cp -r templates $HAMMER_BACKEND_DIR

# Return to original dir + silence the print
cd - > /dev/null

echo "Done! Run 'hammer help' to get started."

